<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:cloudhub="http://www.mulesoft.org/schema/mule/cloudhub" xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/cloudhub http://www.mulesoft.org/schema/mule/cloudhub/current/mule-cloudhub.xsd">
	<sub-flow name="send-email-alert" doc:id="5d3a488d-4029-4649-9085-0fef89f8de3f" >
		<async doc:name="Async" doc:id="027fa6dc-8bc6-4db2-a682-d2799b3060d2" >
			<ee:transform doc:name="Transform Message" doc:id="53a30459-a655-4056-929f-69af719e902e" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
var env = p('env') default ""
var httpCode = error.muleMessage.attributes.statusCode default ""
var httpResponse = (error.description default "") ++ "<br>" ++ (vars.errorDisplay replace " || " with "<br>" default "")
var timeOccurred = now()
var blendGuid = vars.blendLoanId default ""
var loanRefNum = vars.loanRefNum default ""
var losId = vars.externalLoanId default ""
var blendInstance = vars.tenantInstance default ""
var numOfRetries = p("externalRequest.long-retry.attempts")
var email_to = if (p("secure::losConnectors.neto.email_to") != null and p("secure::losConnectors.neto.email_to") != "")
		p("secure::losConnectors.neto.email_to") splitBy(",")
	else
		[]	
var email_cc = if (p("secure::losConnectors.neto.email_cc") != null and p("secure::losConnectors.neto.email_cc") != "")
		p("secure::losConnectors.neto.email_cc") splitBy(",")
	else
		[]
var email_bcc = if (p("secure::losConnectors.neto.email_bcc") != null and p("secure::losConnectors.neto.email_bcc") != "")
		p("secure::losConnectors.neto.email_bcc") splitBy(",")
	else
		[]
---
{
    "email_subject": "Huntington " ++ env ++ " - Export Failed after " ++ numOfRetries ++ " long retries",
    "email_body": "Loan export <b>failed</b>.<br/><ul><li>HTTP Status Code: " ++ httpCode ++"</li><li>Time occurred: " ++ timeOccurred ++"</li><li>Blend GUID: " ++ blendGuid ++"</li><li>Reference Loan Number: " ++ loanRefNum ++"</li><li>Huntington Loan Number: " ++ losId ++"</li><li>Blend Instance: " ++ blendInstance ++"</li><li>Huntington Instance: " ++ customerInstance ++ "</li></ul>",
    "email_to": email_to,
    "email_cc": email_cc,
    "email_bcc": email_bcc
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<http:request method="POST" doc:name="Request" doc:id="7ce170ca-628f-4786-98c9-78aad0d2645e" config-ref="msutil_config" path="/email" />
		</async>
		
	</sub-flow>
	<error-handler name="global-error-handler" doc:id="f4a05078-fb7f-4800-a51e-c3b31cf0e6b5" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="dfa39461-cc0c-4872-a9fd-86b52b4e30bf" type="HTTP:NOT_FOUND, APIKIT:NOT_FOUND">
			<ee:transform doc:name="Transform Message" doc:id="ac4d5f10-6194-47c3-b50a-7fb8bc790e02">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "Not found",
  "display": "Not found", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
404]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="c4f6806e-4ed9-41f3-8107-6a1f6433b138" type="APIKIT:BAD_REQUEST, HTTP:BAD_REQUEST">
			<ee:transform doc:name="Transform Message" doc:id="e48ebf98-80a8-4827-b000-6e9b09e840cc" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "Bad Request",
  "display": "Bad Request", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
400]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="69a84a47-c3be-4fd3-a6f7-4746efe4ce4e" type="APIKIT:METHOD_NOT_ALLOWED, HTTP:METHOD_NOT_ALLOWED">
			<ee:transform doc:name="Transform Message" doc:id="f194c66e-79b5-49ae-a682-8fd761fafcaa" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "error": "Not Allowed",
  "display": "Not Allowed", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
405]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="55c77cc1-f7ca-4d72-908a-407cebb09929" type="APIKIT:NOT_ACCEPTABLE, HTTP:NOT_ACCEPTABLE">
			<ee:transform doc:name="Transform Message" doc:id="51c4cd4b-abfd-435a-86dd-608a58da4d0a" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "Not Acceptable",
  "display": "Not Acceptable", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
406]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="b41585e9-e581-4c35-9647-288a89b4283b" type="APIKIT:UNSUPPORTED_MEDIA_TYPE, HTTP:UNSUPPORTED_MEDIA_TYPE">
			<ee:transform doc:name="Transform Message" doc:id="cbd32e7a-58e3-4a89-9821-39d7b0c27a48" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "Unsupported Media Type",
  "display": "Unsupported Media Type", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
415]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="b1d3aa29-6c20-4061-ac03-52f16d2e7780" type="HTTP:TOO_MANY_REQUESTS">
			<ee:transform doc:name="Transform Message" doc:id="66a94405-029c-48c0-811b-d557386e73a6" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "too many Requests",
  "display": "Too many Requests", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
429]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="9f92b8ec-62fd-4b2c-b656-fbf567c81543" type="APIKIT:NOT_IMPLEMENTED">
			<ee:transform doc:name="Transform Message" doc:id="5f508459-2f57-4fc6-a912-3ebe5373ed6d" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "Not implemented",
  "display": "Not implemented", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
501]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="fde89aad-0a19-4392-8a04-64845f185d29" type="HTTP:CONNECTIVITY, HTTP:RETRY_EXHAUSTED, HTTP:SERVICE_UNAVAILABLE">
			<ee:transform doc:name="Transform Message" doc:id="8925b35e-2345-4ee6-90bf-7eca67c4f776" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "HTTP Connectivity",
  "display": "HTTP Connectivity", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
503]]></ee:set-variable>
					<ee:set-variable variableName="emailPayload" ><![CDATA[%dw 2.0
output application/json
---
{
	"Failure Message" : "HTTP CONNECTIVITY issue",
	"Time Occurred" : now() as String,
	"Source system" : "Expedite(LOS Name)",
	"Provider" : "Expedite",
	"Blend Instance" : p('secure::blend-msutil.https.tenant'),
	"Blend Loan Id" : vars.applicationId default "N/A",
	"Event Status" : vars.eventStatus,
	"LOS Loan ID" : vars.losId deafault "N/A",
	"Mule Transaction ID" : correlationId
}]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="send-email-alert" doc:id="8e63c920-2406-4e5c-8948-919ef2ae5d2e" name="send-email-alert"/>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="adf0d084-a637-4f9b-9c47-2e2bfe7724fb" type="HTTP:TIMEOUT">
			<ee:transform doc:name="Transform Message" doc:id="ab352ae0-6f00-46e3-9964-241ecb1e5b37" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "HTTP Timeout",
  "display": "HTTP Timeout", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
408]]></ee:set-variable>
					<ee:set-variable variableName="emailPayload" ><![CDATA[%dw 2.0
output application/json
---
{
	"Failure Message" : "HTTP CONNECTIVITY issue",
	"Time Occurred" : now() as String,
	"Source system" : "Expedite(LOS Name)",
	"Provider" : "Expedite",
	"Blend Instance" : p('secure::blend-msutil.https.tenant'),
	"Blend Loan Id" : vars.applicationId default "N/A",
	"Event Status" : vars.eventStatus,
	"LOS Loan ID" : vars.losId deafault "N/A",
	"Mule Transaction ID" : correlationId
}]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<flow-ref doc:name="send-email-alert" doc:id="94425435-2a70-4b4c-a5ab-0368257dd243" name="send-email-alert"/>
		</on-error-propagate>
<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="ecbe6abe-9c81-4bef-b8cf-64133d6ea4a1" type="EXPRESSION" when='error.description contains "MISMO Error"'>
			<ee:transform doc:name="Transform Message" doc:id="de1c4816-dc3b-4c88-a8d5-2d6e34ffdbfd" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
var errorMessage = if (error.description contains("Something")) "Something cannot be empty" 
else if (error.description contains("Otherthing")) "Otherthing cannot be empty"
else "Missing Data"
---
{
  "error": errorMessage,
  "display": "SourceSystem = Expedite" ++ "|| ErrorMessage = " ++ errorMessage, // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="emailPayload" ><![CDATA[%dw 2.0
output application/json
var errorMessage = if (error.description contains("DOCUMENT_SETS")) "DOCUMENT_SETS cannot be empty" 
else if (error.description contains("TWPostingType")) "TWPostingType cannot be empty"
else "Missing Data"
---
{
	"Failure Message" : error.errorType.namespace ++ ":" ++ error.errorType.identifier,
	"HTTP Status Code" : 400,
	"Error Response Details" : errorMessage,
	"Time Occurred" : error.errorMessage.payload.dateTime default now(),
	"Source system" : "Expedite",
	"Customer" : "Expedite(LOS System)",
	"eventType": vars.eventType,
	"Blend Instance" : p('secure::blend.tenant')
}]]></ee:set-variable>
					<ee:set-variable variableName="httpStatus" ><![CDATA[400]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<json-logger:logger doc:name="errorResponse" doc:id="549aede2-4135-4028-af3d-3aeeec11055b" config-ref="json_logger_config" message="#[error.description]" tracePoint="EXCEPTION" priority="ERROR">
				<json-logger:content ><![CDATA[#[output application/json ---
{
}]]]></json-logger:content>
			</json-logger:logger>
			<flow-ref doc:name="send-email-alert" doc:id="9dbc1249-ead4-48ea-b739-29cefcc93eb4" name="send-email-alert"/>
		
</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="7d144948-8ec2-427b-838f-3b09c26a47c4" type="HTTP:FORBIDDEN, HTTP:NOT_ACCEPTABLE, HTTP:PARSING, HTTP:SECURITY, HTTP:UNAUTHORIZED">
			<ee:transform doc:name="Transform Message" doc:id="92b2c9e4-46ce-4979-832d-7db6531da300" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "HTTP Forbidden",
  "display": "HTTP Forbidden", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/java
---
403]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="d493a574-367a-4911-9cf3-54182a539d53" type="ANY">
			<ee:transform doc:name="Transform Message" doc:id="8ecb6a8e-829c-4d64-a1e7-1bc74e20f816">
				<ee:message>
					<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
  "error": "Internal Server Error",
  "display": "Internal Server Error", // can be updated to provide developers comment to give more context,
  "externalLoanId": "tbd",
  "blendLoanId" : "tbd",
  "transactionId" : correlationId
}]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="emailPayload" ><![CDATA[%dw 2.0
output application/json
---
{
"Failure Message" : error.errorType.namespace ++ ":" ++ error.errorType.identifier,
"HTTP Status Code" : error.muleMessage.attributes.StatusCode default 500,
"Error Response Details" : error.description,
"Time Occurred" : error.errorMessage.payload.dateTime default now(),
"Source system" : "Expedite",
"Customer" : "Expedite",
//"Source Account Id" : accountId,
"Blend Instance" :  p('secure::blend-msutil.https.tenant'),
//"Blend Package GUID" : blendPackageId,
//"Blend Application GUID" : blendAppId,
"Reference Package Id" : vars.packageId default "",
"Reference Loan Id" : vars.losId default "",
  
}]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<json-logger:logger doc:name="errorResponse" doc:id="3aef39b1-083d-46b4-8a53-1acd3fd0b1c4" config-ref="json_logger_config" message="#[error.description]" tracePoint="EXCEPTION" />
			<flow-ref doc:name="send-email-alert" doc:id="9d5a919d-590c-4c86-a75f-753c23dd26d6" name="send-email-alert" />
		
</on-error-propagate>
	</error-handler>
</mule>